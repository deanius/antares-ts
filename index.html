<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Antares Agent Client-side Test</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="//cdnjs.cloudflare.com/ajax/libs/rxjs/6.2.1/rxjs.umd.min.js"></script>
    <script src="//unpkg.com/redux@4.0.0/dist/redux.js"></script>
    <script src="./dist/antares-protocol.js"></script>
    <script src="https://unpkg.com/oboe@2.1.4/dist/oboe-browser.js"></script>
    <script>
        let agent
        let after // an RxJS-Observable-based delay utility
        let ajaxStreamingGet
        let randomIdFilter
        if (typeof AntaresProtocol !== "undefined") {
            agent = new AntaresProtocol.Agent
            after = AntaresProtocol.after
            ajaxStreamingGet = AntaresProtocol.ajaxStreamingGet
            randomIdFilter = AntaresProtocol.randomIdFilter
            console.log("Antares is Ready")
        } else {
            console.log("Antares Loading Error")
        }


        // Welcome, reader of the Source!
        // This is just a little demo to show how in Antares you
        // - Define event-handling behavior which
        //   - matches on type and
        //   - returns an Observable
        // - Process some actions or subscribe to a process which does
        // What it does: We send you to a new browser location (in your Address Bar)
        // while you read this

        // Define a renderer which changes the browser's address bar (after a delay)
        agent.on('browser/go', ({ action }) => {
            return after(2000, () => document.location.hash = action.payload)
        })

        // Create a store in which to reduce actions.
        // Note we dont actually bother with a reducer, but allow devtools to instrument us
        const store = Redux.createStore(
            (state = {}, { type, payload }) => {
                switch (type) {
                    case 'repos':
                        return { repos: payload }
                    default:
                        return state
                }
            },
            window.__REDUX_DEVTOOLS_EXTENSION__ && window.__REDUX_DEVTOOLS_EXTENSION__()
        )

        // append a random GIT-SHA-like identifier to each action
        agent.addFilter(randomIdFilter())
        // Send all actions, including those returned by renderers through the store
        agent.addFilter(({ action }) => store.dispatch(action))

        // And print out repo(s) as we get them
        agent.on(/repo/, ({ action }) => {
            const { payload } = action
            console.log(payload.shift ? payload.join("\n") : payload)

            // if recieved batches (arrays)
            if (payload.shift) {
                document.getElementById("repos").innerHTML = payload.map(r => `<div>${formatRepo(r)}</div>`).join("")
            } else {
                const child = document.createElement("div")
                child.innerHTML = formatRepo(payload)
                document.getElementById("repos").appendChild(child)
            }
        })

        function formatRepo(name) {
            const mark = (name === 'deanius/antares' ? 'âž½ ' : '')
            return `<a class="repo" href="//github.com/${name}">${mark}${name}</a>`
        }

        let canceled = new rxjs.Subject()
        function clickCancel() {
            console.log('cancel clicked')
            canceled.next();
            canceled.complete()
            console.log('ajax canceled')
        }

        document.addEventListener('DOMContentLoaded', () => {

            // Kick off the action - we should expect to see an update in the address bar!
            if (document.location.hash.length === 1) {
                agent.process({
                    type: 'browser/go',
                    payload: '#WhatWouldYouLikeToKnow?'
                })
            }
            if (document.location.hash === "#slow") {
                // pseudo streaming - if you don't have oboe installed
                ajaxStreamingGet({
                    url: 'https://untitled-yd6fw62bsoo0.runkit.sh/',
                    expandKey: 'items',
                    lib: 'rxjs'
                }).pipe(
                    rxjs.operators.takeUntil(canceled)
                ).subscribe({
                    next(repo) {
                        agent.process({ type: 'repo', payload: repo.full_name })
                    }, complete() {
                        console.log('done')
                    }
                })
            } else if (document.location.hash === "#single") {
                // Streaming singly
                ajaxStreamingGet({
                    url: 'https://untitled-yd6fw62bsoo0.runkit.sh/',
                    expandKey: 'items[*]',
                    lib: 'oboe'
                }).pipe(
                    rxjs.operators.takeUntil(canceled)
                ).subscribe({
                    next(repo) {
                        agent.process({ type: 'repo', payload: repo.full_name })
                    }, complete() {
                        console.log('done')
                    }
                })
            } else {
                // Actual streaming - incremental loading style (the initial $ in expandKey)
                ajaxStreamingGet({
                    url: 'https://untitled-yd6fw62bsoo0.runkit.sh/',
                    expandKey: '$items[*]',
                    lib: 'oboe'
                }).pipe(
                    rxjs.operators.takeUntil(canceled)
                ).subscribe({
                    next(repos) {
                        agent.process({ type: 'repos', payload: repos.map(r => r.full_name) })
                    }, complete() {
                        console.log('done')
                    }
                })
            }
        })
    </script>
    <style>
        #c {
            border: 0.5px solid black;
            width: 60px;
            height: 20px;
        }

        a {
            text-decoration: none;
            color: black;
        }

        a:hover {
            text-decoration: underline;
            color: blue;
        }
    </style>
</head>

<body>
    <h5>Antares is watching you!</h5>
    <canvas id="c"></canvas>
    <h1>Links</h1>
    <ul>
        <li>
            <a href="docs/index.html">JSDoc Documentation</a>
        </li>
        <li>
            <a href="javascript:window.__REDUX_DEVTOOLS_EXTENSION__.open()">Open DevTools</a>
        </li>
    </ul>

    <h2>Top 12 Projects Named 'antares' on Github</h2>
    <div style="font-size: smaller;">
        <a href="#" onclick="clickCancel()">Cancel</a></div>
    <div id="repos" />

    <!-- A use of RxJS (without Antares) to do a fun animation -->
    <script src="demos/home/kitt.js"></script>

</body>

</html>
